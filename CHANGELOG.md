# 更新日志 (CHANGELOG)

## [0.6.2] - 2025-08-09

### 🧪 测试覆盖增强
- **错误处理测试**: 为 `error` 模块添加17个全面的测试用例，覆盖 `WinnowErrorEx` 的所有错误模式
- **全局变量测试**: 为 `global` 模块添加完整的单元测试，包括系统信息获取和环境变量设置功能
- **类型系统测试**: 为 `UpdateUnit` 添加全面的单元测试，覆盖构造器、getter/setter 和 trait 实现
- **多模块测试**: 为 `dict.rs`、`error.rs`、`local.rs`、`upload_options.rs`、`opt.rs`、`types.rs`、`git.rs`、`update.rs` 和 `origin.rs` 模块添加大量测试用例

### 🔧 代码质量改进
- **类型系统增强**: 为 `UpdateUnit` 结构体添加 `Debug` 和 `PartialEq` trait 派生，便于调试和比较
- **代码清理**: 移除死代码，清理临时文件，优化项目结构
- **测试重构**: 更新测试中的格式化字符串写法，遵循 Rust 最佳实践

### 🐛 错误修复
- **全局变量修复**: 修复 `global` 模块中的 bug，提高系统稳定性
- **CI/CD 优化**: 修复 CI 工作流程和代码覆盖率配置问题

### 🔧 开发者体验
- **文档更新**: 更新 CI badge 和代码覆盖率服务配置
- **版本管理**: 完善版本发布流程

---

## [0.6.1] - 2025-08-08

### ⚡ 网络性能与稳定性提升

#### 🕐 超时控制系统
- **智能超时配置**: 实现可配置的 HTTP 客户端超时参数，包括连接、读取和总超时控制
- **场景化预设**: 为不同使用场景提供预设配置：
  - 常规 HTTP 操作
  - 大文件下载
  - Git 操作
- **超时错误处理**: 扩展错误类型，包含超时相关的详细错误信息

#### 🔄 智能重试机制
- **自动重试**: 实现失败操作的自动重试功能，提高网络请求的可靠性
- **重试策略**: 支持配置重试次数和重试间隔
- **重试错误追踪**: 提供详细的重试失败原因和重试次数统计

#### 🔧 代理配置优化
- **代理逻辑重构**: 优化代理和超时配置的处理逻辑，提高配置的灵活性
- **客户端创建**: 新增 `create_http_client_by_ctrl` 函数，支持通过 `UnitCtrl` 配置超时和代理
- **模块化改进**: 将客户端相关代码迁移到 `accessor/client` 子模块，提高代码组织性

#### 📚 文档与开发工具
- **覆盖率迁移**: 添加覆盖率服务迁移指南文档 (`docs/coverage-migration.md`)
- **开发计划更新**: 更新开发计划文档，标记已完成的任务
- **测试优化**: 移除过时的测试文件，添加新的超时和重试功能测试

### 技术变更

#### 模块重构
- **addr 模块重组**: 重构 `addr` 模块结构，将相关功能分离到子模块
- **错误处理增强**: 新增超时和重试相关的错误类型和处理机制
- **API 扩展**: 新增 HTTP 客户端创建和配置的 API

#### 代码质量
- **Clippy 优化**: 修复所有 Clippy 警告，遵循 Rust 最佳实践
- **代码格式化**: 统一代码格式，提高可读性

### 配置示例

#### 超时配置使用
```rust
// 大文件下载场景
let result = downloader
    .download(
        &addr,
        &path,
        DownloadOptions::for_test()
            .with_http_large_file_timeout(), // 一行配置大文件下载超时
    )
    .await?;
```

#### 代理配置使用
```rust
// 通过 UnitCtrl 配置代理和超时
let client = create_http_client_by_ctrl(&unit_ctrl)?;
```

### 测试
- ✅ 新增超时控制功能测试用例
- ✅ 重试机制全面测试覆盖
- ✅ 代理配置功能验证
- ✅ 错误处理场景测试

---

## [0.6.0] - 2024-12-19

### 新增功能

#### 🔄 重定向服务增强
- **环境变量支持**: 为RedirectService及其所有组件添加完整的EnvEvalable能力
  - 支持在Rule的pattern和target字段中使用环境变量
  - 支持在AuthConfig的username和password字段中使用环境变量
  - 支持环境变量默认值语法：`${VAR:default_value}`
  - 支持嵌套环境变量解析

#### 📋 配置格式优化
- **简化配置结构**: 移除冗余的`direct_serv`顶级包装，直接使用`enable`和`units`作为顶级字段
- **向后兼容**: 保持所有现有API不变，确保平滑升级
- **配置验证**: 新增配置格式验证功能，提供更友好的错误提示

#### 🔧 开发者体验改进
- **详细文档**: 新增完整的重定向规则配置文档 (`docs/redirect-rules.md`)
- **丰富示例**: 提供GitHub镜像、企业代理、最小配置等多种使用场景示例
- **测试覆盖**: 新增27个单元测试，确保环境变量功能的稳定性

### 技术变更

#### 代码重构
- **模块化改进**: 将地址相关常量迁移到`addr::constants`模块
- **错误处理**: 优化AddrError类型，提供更具体的错误分类
- **代码质量**: 改进内部实现，提高可维护性

#### API更新
- **新增方法**: 
  - `RedirectService::from_str()` - 从字符串直接加载配置
  - `RedirectService::from_file()` - 从配置文件加载（重命名自try_from）
- **保持兼容**: 所有现有API保持不变，无需修改现有代码

### 配置示例

#### 环境变量使用
```yaml
# 支持环境变量的配置
enable: true
units:
  - rules:
      - pattern: "https://${DOMAIN:github.com}/*"
        target: "https://${MIRROR:ghproxy.com}/"
    auth:
      username: "${GITHUB_USER}"
      password: "${GITHUB_TOKEN}"
```

#### 最小配置
```yaml
enable: true
units:
  - rules:
      - pattern: "https://github.com/*"
        target: "https://mirror.github.com/"
```

### 破坏性变更
- 无破坏性变更，所有现有配置继续兼容

### 测试
- ✅ 27个测试全部通过
- ✅ 环境变量扩展功能测试覆盖
- ✅ 向后兼容性验证
- ✅ 配置格式验证测试

### 文档
- 📖 新增《地址重定向规则配置文档》
- 📚 更新API参考文档
- 🎯 提供完整配置示例和使用指南

---

## [0.5.9] - 2024-12-15

### 新增功能
- 初始重定向服务实现
- 支持通配符匹配规则
- 支持基本认证配置
- 提供配置文件支持